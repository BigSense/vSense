---
# add aptly repo
- apt_key: keyserver=keys.gnupg.net id=2A194991
- apt_repository: repo='deb http://repo.aptly.info/ squeeze main' state=present

# Install packages
- action: apt update_cache=yes
- action: apt name=dpkg-sig
- action: apt name=nginx
- action: apt name=aptly

# Create Repo Management User and set permissions
- user: name=repoman
- file: path=/home/repoman/debs state=directory owner=repoman group=repoman mode=0775

# Copy PGP Keys
- copy: src=../bigsense.pub dest={{ repoman_home }} owner=root group=repoman mode=0650
- copy: src=../bigsense.sec dest={{ repoman_home }} owner=root group=repoman mode=0650

# Create aptly repo db
- template: src=aptly.conf.j2 dest={{ repoman_home }}/{{ item.version }}.aptly owner=root mode=0644
  with_items: repos
- command: aptly repo create -comment="bigsense repository" -config=/home/repoman/{{ item.version }}.aptly {{ item.version }} creates={{ repo_init }}
  with_items: repos
  register: create_repo
  sudo_user: repoman
- file: path={{ repo_init }} state=touch
  when: create_repo|success

#publish repo
- shell: aptly -distribution={{ item.version }} -architectures=all -config={{ repoman_home }}/{{ item.version }}.aptly publish repo {{ item.version }} creates={{ publish_init }}
  with_items: repos
  register: publish_repo
  sudo_user: repoman
- file: path={{ publish_init }} state=touch
  when: publish_repo | success

#add publishing script and copy ssh transfer keys
- copy: src=publish dest={{ repoman_home }} owner=root group=repoman mode=0650
- authorized_key: user=repoman key={{ lookup('file','../jenkins.ssh.pub') }}

# serve repo though nginx
- template: src=nginx.j2 dest=/etc/nginx/sites-available/repo owner=root group=root mode=0644
- file: src=/etc/nginx/sites-available/repo dest=/etc/nginx/sites-enabled/repo owner=root group=root state=link
- file: path=/etc/nginx/sites-enabled/default state=absent
- service: name=nginx enabled=yes state=started
