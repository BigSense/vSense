---
# add aptly repo
- apt_key: keyserver=keys.gnupg.net id=2A194991
- apt_repository: repo='deb http://repo.aptly.info/ squeeze main' state=present

# Install packages
- action: apt update_cache=yes
- action: apt name=dpkg-sig
- action: apt name=nginx
- action: apt name=aptly

# Create Repo Management User and set permissions
- user: name=repoman
- file: path={{ repoman_home }}/debs state=directory owner=repoman group=repoman mode=0775

# Copy and Import PGP Keys
- copy: src=../bigsense.pub dest={{ repoman_home }} owner=root group=repoman mode=0650
- copy: src=../bigsense.sec dest={{ repoman_home }} owner=root group=repoman mode=0650
- template: src=bigsense.passphrase.j2 dest={{ pgp_passfile }} owner=repoman mode=0400
- command: gpg --import {{ repoman_home }}/bigsense.sec creates={{ repoman_home }}/.gnupg/secring.gpg
  sudo_user: repoman

# Create aptly repo db
- template: src=aptly.conf.j2 dest={{ repoman_home }}/{{ item.version }}.aptly owner=root mode=0644
  with_items: repos[0]
- command: aptly repo create -comment="bigsense repository" -component={{ item[1] }} -config=/home/repoman/{{ item[0].version }}.aptly {{ item[0].version }}-{{ item[1] }} creates={{ repo_init }}
  with_nested: repos
  register: create_repo
  sudo_user: repoman
- file: path={{ repo_init }} state=touch
  when: create_repo|success

#publish repo
- shell: aptly -passphrase=$(cat {{ pgp_passfile }}) -distribution={{ item.version }} -component={{repos[1]|join(',')}} -architectures=all -config={{ repoman_home }}/{{ item.version }}.aptly publish repo {% for i in repos[1] %}{{item.version}}-{{i}} {% endfor %}  creates={{ publish_init }}
  with_items: repos[0]
  register: publish_repo
  sudo_user: repoman
- file: path={{ publish_init }} state=touch
  when: publish_repo | success
- shell: gpg --export -a "BigSensePGPKey" > {{ repoman_home }}/public/bigsense.io.key
  sudo_user: repoman

#add publishing script and copy ssh transfer keys
- copy: src=publish dest={{ repoman_home }} owner=root group=repoman mode=0550
- file: path={{ repoman_home }}/.ssh state=directory owner=repoman group=repoman mode=0700
- copy: src=../jenkins.ssh.pub dest={{ repoman_home }}/.ssh/authorized_keys owner=repoman group=repoman mode=0600
# Not sure why this doesn't work
#- authorized_key: user=repoman key={{ lookup('file','/home/sumit/sensespace/vSense/virtual-env/build/jenkins.ssh.pub') }}

# serve repo though nginx
- template: src=nginx.j2 dest=/etc/nginx/sites-available/repo owner=root group=root mode=0644
- file: src=/etc/nginx/sites-available/repo dest=/etc/nginx/sites-enabled/repo owner=root group=root state=link
- file: path=/etc/nginx/sites-enabled/default state=absent
- service: name=nginx enabled=yes state=started
